import React, { useEffect, useMemo, useRef } from "react";
import * as THREE from "three";
import { gsap } from "gsap";

/**
 * React — Campo de Flores Amarillas (GSAP + Three.js)
 * - Cielo oscuro con estrellas (WebGL) + estrella fugaz
 * - Campo completo de flores que NACE en capas (profundidad con blur sutil)
 * - Flores rediseñadas: 3 coronas de pétalos + halo dorado + semillitas
 * - Animaciones suaves con GSAP
 */

// ---------- Utilidades ----------
const petalPath = (R = 18, L = 54) =>
  `M 0 0 C ${R} ${-L * 0.25}, ${R * 0.78} ${-L * 0.82}, 0 ${-L} C ${-R * 0.78} ${-L * 0.82}, ${-R} ${-L * 0.25}, 0 0 Z`;

const Seeds = ({ count = 14 }) => {
  const dots = useMemo(
    () =>
      Array.from({ length: count }).map((_, i) => {
        const a = Math.random() * Math.PI * 2;
        const r = 5 + Math.random() * 9;
        return { cx: Math.cos(a) * r, cy: Math.sin(a) * r, i };
      }),
    [count]
  );
  return (
    <g>
      {dots.map(({ cx, cy, i }) => (
        <circle key={i} cx={cx} cy={cy} r={1.2} fill="#2a1b0b" />
      ))}
    </g>
  );
};

// ---------- Flor individual (nuevo diseño) ----------
const Flower: React.FC<{
  x: number;
  y: number;
  scale: number;
  delay?: number;
  blur?: number;
}> = ({ x, y, scale, delay = 0, blur = 0 }) => {
  const gRef = useRef<SVGGElement | null>(null);
  const stemRef = useRef<SVGPathElement | null>(null);
  const leafLRef = useRef<SVGEllipseElement | null>(null);
  const leafRRef = useRef<SVGEllipseElement | null>(null);
  const petalsRefs = useRef<SVGPathElement[]>([]);
  const centerRef = useRef<SVGCircleElement | null>(null);

  const h = useMemo(() => 170 + Math.random() * 90, []);
  const sway = useMemo(() => (Math.random() * 36 - 18).toFixed(1), []);
  const outer = 16, mid = 12, inner = 8;
  const orbitO = 40, orbitM = 30, orbitI = 18;

  useEffect(() => {
    if (!stemRef.current || !gRef.current) return;
    const stem = stemRef.current;
    const g = gRef.current;

    const L = stem.getTotalLength();
    stem.style.strokeDasharray = String(L);
    stem.style.strokeDashoffset = String(L);

    const tl = gsap.timeline({ defaults: { ease: "power2.out" }, delay });
    tl.to(stem, { strokeDashoffset: 0, duration: 1.6 }, 0)
      .from(
        [leafLRef.current, leafRRef.current],
        { scale: 0.2, opacity: 0, duration: 0.55, stagger: 0.1, transformOrigin: "50% 50%" },
        0.7
      )
      .from(
        petalsRefs.current,
        { scale: 0.01, rotation: -8, opacity: 0, duration: 0.52, stagger: 0.03, transformOrigin: "50% 100%" },
        0.95
      )
      .from(centerRef.current, { scale: 0.3, opacity: 0, duration: 0.5 }, "-=0.2")
      .to(
        g,
        { rotation: 0.8, duration: 3.6, ease: "sine.inOut", yoyo: true, repeat: -1, transformOrigin: "50% 100%" },
        "+=0.2"
      );

    return () => { tl.kill(); };
  }, [delay]);

  const setPetalRef = (el: SVGPathElement | null, idx: number) => {
    if (el) petalsRefs.current[idx] = el;
  };

  return (
    <g
      ref={gRef}
      transform={`translate(${x},${y}) scale(${scale})`}
      style={{ filter: blur ? `blur(${blur}px)` : undefined }}
    >
      {/* Halo dorado suave */}
      <g opacity={0.2}>
        <circle cx={0} cy={-h} r={44} fill="#ffdf80" />
        <circle cx={0} cy={-h} r={72} fill="#ffdf80" opacity={0.22} />
      </g>

      {/* Tallo */}
      <path
        ref={stemRef}
        d={`M0,0 C ${sway},-${h * 0.4} ${Number(sway) / 2},-${h * 0.8} 0,-${h}`}
        stroke="url(#stemGrad)"
        strokeWidth={8}
        fill="none"
        strokeLinecap="round"
      />

      {/* Hojas */}
      <ellipse ref={leafLRef} cx={-18} cy={-h * 0.55} rx={18} ry={10} fill="#7ad674" transform="rotate(-16 -18 -120)" />
      <ellipse ref={leafRRef} cx={18} cy={-h * 0.72} rx={18} ry={10} fill="#6ac86f" transform="rotate(16 18 -150)" />

      {/* Cabeza: 3 coronas de pétalos */}
      <g transform={`translate(0,${-h})`}>
        {[{ n: outer, orbit: orbitO, r: 20, l: 54, op: 1 },
          { n: mid,   orbit: orbitM, r: 17, l: 44, op: .95 },
          { n: inner, orbit: orbitI, r: 12, l: 30, op: .9 }].map((ring, ringIdx) => (
          <g key={ringIdx} opacity={ring.op}>
            {Array.from({ length: ring.n }).map((_, i) => {
              const a = (Math.PI * 2 * i) / ring.n + (ringIdx === 1 ? Math.PI / ring.n : 0);
              const px = Math.cos(a) * ring.orbit, py = Math.sin(a) * ring.orbit;
              const idx = (ringIdx === 0 ? 0 : ringIdx === 1 ? outer : outer + mid) + i;
              return (
                <path
                  key={`ring-${ringIdx}-${i}`}
                  ref={(el) => setPetalRef(el, idx)}
                  d={petalPath(ring.r, ring.l)}
                  fill="url(#petalGrad)"
                  transform={`translate(${px},${py}) rotate(${(a * 180) / Math.PI})`}
                />
              );
            })}
          </g>
        ))}
        {/* Centro + brillos + semillas */}
        <circle ref={centerRef} cx={0} cy={0} r={20} fill="url(#centerGrad)" />
        <circle cx={-6} cy={-6} r={3} fill="#fff8d1" opacity={0.5} />
        <circle cx={4} cy={-8} r={2} fill="#fff3b0" opacity={0.35} />
        <Seeds count={14} />
      </g>
    </g>
  );
};

// ---------- Cielo 3D ----------
const Stars3D: React.FC = () => {
  const mountRef = useRef<HTMLDivElement | null>(null);
  useEffect(() => {
    const mount = mountRef.current!;
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    mount.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
    camera.position.z = 5;

    const starCount = 1600;
    const positions = new Float32Array(starCount * 3);
    for (let i = 0; i < starCount; i++) {
      const r = 38 * Math.random() + 6;
      const th = Math.random() * Math.PI * 2;
      const ph = Math.acos(2 * Math.random() - 1);
      positions[i * 3 + 0] = r * Math.sin(ph) * Math.cos(th);
      positions[i * 3 + 1] = r * Math.sin(ph) * Math.sin(th);
      positions[i * 3 + 2] = r * Math.cos(ph);
    }
    const geo = new THREE.BufferGeometry();
    geo.setAttribute("position", new THREE.BufferAttribute(positions, 3));
    const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.02, transparent: true, opacity: 0.85 });
    const stars = new THREE.Points(geo, mat);
    scene.add(stars);

    function onResize() {
      const w = mount.clientWidth || window.innerWidth;
      const h = mount.clientHeight || window.innerHeight;
      renderer.setSize(w, h);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", onResize);
    onResize();

    let raf: number;
    const loop = () => {
      stars.rotation.y += 0.0005;
      stars.rotation.x += 0.00025;
      renderer.render(scene, camera);
      raf = requestAnimationFrame(loop);
    };
    loop();

    return () => {
      cancelAnimationFrame(raf);
      window.removeEventListener("resize", onResize);
      mount.removeChild(renderer.domElement);
      renderer.dispose();
      geo.dispose();
      mat.dispose();
    };
  }, []);
  return <div ref={mountRef} style={{ position: "fixed", inset: 0, zIndex: -10 }} />;
};

// ---------- Página ----------
export default function CampoDeFlores() {
  // Estrella fugaz
  useEffect(() => {
    const spawn = () => {
      const m = document.createElement("div");
      Object.assign(m.style, {
        position: "fixed", left: "-10vw", top: "-10vh",
        width: "2px", height: "2px", background: "#fff", borderRadius: "50%",
        boxShadow: "0 0 10px 3px #fff, 0 0 20px 8px rgba(255,255,255,.55)",
        zIndex: 20, opacity: 0.95
      });
      document.body.appendChild(m);
      const sx = -10 + Math.random() * 10;
      const sy = 5 + Math.random() * 22;
      m.style.left = sx + "vw";
      m.style.top = sy + "vh";
      gsap.fromTo(m, { x: 0, y: 0, opacity: 0.95 }, {
        x: "120vw", y: "85vh", opacity: 0, duration: 2.3, ease: "power2.out",
        onComplete: () => m.remove()
      });
    };
    const t1 = setTimeout(spawn, 1600);
    const int = setInterval(() => { if (Math.random() > 0.6) spawn(); }, 10000);
    return () => { clearTimeout(t1); clearInterval(int); };
  }, []);

  // Capas del campo (profundidad)
  const layers = useMemo(() => {
    const baseY = 620; const gapY = 70;
    const configs = [
      { rows: [10, 12, 10], blur: 0,   scaleBias: 1.0,  span: 900 }, // frente
      { rows: [8,  9,  8],  blur: 0.7, scaleBias: 0.86, span: 880 }, // medio
      { rows: [7,  8,  7],  blur: 1.4, scaleBias: 0.74, span: 860 }, // fondo
    ];
    const out: { x:number; y:number; s:number; delay:number; blur:number }[] = [];
    let globalDelay = 0;
    configs.forEach((cfg, li) => {
      cfg.rows.forEach((n, rIdx) => {
        const y = baseY - (li * 3 + rIdx) * (gapY * 0.85);
        const span = cfg.span - rIdx * 80;
        for (let i = 0; i < n; i++) {
          const off = i - (n - 1) / 2;
          const x = 500 + off * (span / n);
          const s = cfg.scaleBias * (0.9 + Math.random() * 0.08);
          out.push({ x, y, s, delay: globalDelay, blur: cfg.blur });
          globalDelay += 0.08;
        }
        globalDelay += 0.12;
      });
      globalDelay += 0.2;
    });
    return out;
  }, []);

  return (
    <div
      className="relative min-h-screen overflow-hidden"
      style={{
        color: "#eaf0ff",
        background:
          "radial-gradient(85% 55% at 50% 0%, #060915 0%, transparent 70%), linear-gradient(180deg, #04050a 0%, #02030a 100%)",
      }}
    >
      <Stars3D />

      {/* Frase */}
      <header
        style={{
          position: "fixed", top: 24, left: "50%", transform: "translateX(-50%)",
          zIndex: 30, width: "min(960px,92vw)", textAlign: "center"
        }}
      >
        <h1 style={{ fontFamily: "Playfair Display, serif", margin: 0, fontSize: "clamp(1.7rem,3.2vw,2.6rem)", letterSpacing: ".2px" }}>
          Un campo de flores que nace para ti — y tú brillas como el amarillo en la noche
        </h1>
        <p style={{ marginTop: 8, color: "#b7c2dd", maxWidth: "72ch", marginInline: "auto" }}>
          No puedo llevarte flores en persona; por eso te regalo este <span style={{ fontWeight: 600, color: "#ffd66e" }}>campo que nace</span>.
          En el cielo oscuro, tu luz amarilla lo enciende todo.
        </p>
      </header>

      {/* Campo de flores */}
      <div style={{ position: "fixed", inset: 0, zIndex: 10, display: "grid", placeItems: "end", paddingBottom: "5vh" }}>
        <svg viewBox="0 0 1000 700" style={{ width: "min(1400px,96vw)", height: "min(78vh,80vw)", overflow: "visible" }}>
          <defs>
            <radialGradient id="petalGrad" cx="30%" cy="30%" r="70%">
              <stop offset="0%"  stopColor="#fff6c7" />
              <stop offset="52%" stopColor="#ffe48f" />
              <stop offset="86%" stopColor="#ffd04a" />
              <stop offset="100%" stopColor="#ffb300" />
            </radialGradient>
            <radialGradient id="centerGrad" cx="50%" cy="45%" r="60%">
              <stop offset="0%"  stopColor="#8b5a2b" />
              <stop offset="100%" stopColor="#332312" />
            </radialGradient>
            <linearGradient id="stemGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%"  stopColor="#7ad674" />
              <stop offset="100%" stopColor="#49b262" />
            </linearGradient>
          </defs>

          {layers.map(({ x, y, s, delay, blur }, idx) => (
            <Flower key={idx} x={x} y={y} scale={s} delay={delay} blur={blur} />
          ))}
        </svg>
      </div>

      {/* Niebla/suelo */}
      <div
        style={{
          position: "fixed", left: 0, right: 0, bottom: 0, height: "42vh", zIndex: 0,
          background: "radial-gradient(100% 70% at 50% 100%, rgba(10,16,32,.9) 0%, rgba(10,16,32,0) 70%)",
          filter: "blur(8px)"
        }}
      />

      <footer
        style={{
          position: "fixed", bottom: 12, left: "50%", transform: "translateX(-50%)",
          zIndex: 30, color: "#cfd8ff", opacity: .85, fontSize: ".95rem"
        }}
      >
        Hecho con cariño bajo un cielo de estrellas ✨
      </footer>
    </div>
  );
}
